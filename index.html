<html>
<body>
  <textarea id="result" rows="8" cols="80"></textarea>
  <img id="container" type="image/svg+xml"/>
  <canvas id="can" style="border:1px solid black;"></canvas>  
<script src="simplify.js"></script>
<script>
/* You must:  

*  Path -> Object to path
* 


*/

var container,canvas,ctx;
var SCALE = 3.385/(2.53*96);
var DRAWSIZE = 2;
var DRAWSCALE = DRAWSIZE/SCALE;
var SUBSAMPLING = 5; // subsampling of SVG path
var SIMPLIFY = 0.1*SCALE;
var SIMPLIFYHQ = false;
var TRACEWIDTH = 0.004;

function loadSVG(url) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
       var svgs = xhr.responseXML.getElementsByTagName("svg");
       if (svgs.length) {
         var newSVG = svgs[0];         
         document.getElementById("container").replaceWith(newSVG);
         container = newSVG;
         setTimeout(drawSVG,0);
       } else alert("No SVG loaded");       
    }
  };
  xhr.open("GET", url, true);
  xhr.send();
}

function dist(a,b) {
  var dx = a.x-b.x;
  var dy = a.y-b.y;
  return Math.sqrt(dx*dx+dy*dy);
}

function unpackPoly(poly) {
  var main = poly[0];
  for (var p=1;p<poly.length;p++) {
    var path = poly[p];
    var minDist = 10000000000;
    var minMain,minPath;
    for (var a=0;a<main.length;a++)
      for (var b=0;b<path.length;b++) {
        var l = dist(main[a],path[b]);
        if (l<minDist) {
          minDist = l;
          minMain = a;
          minPath = b;
        }
      }
    main = main.slice(0, minMain+1).concat(
      path.slice(minPath),
      path.slice(0,minPath+1),
      main.slice(minMain)
    );
  }
  return main;
}

function plotPoly(points) {
  ctx.beginPath();
  ctx.moveTo(points[0].x*DRAWSCALE, points[0].y*DRAWSCALE);
  for (var i=1;i<points.length;i++)
   ctx.lineTo(points[i].x*DRAWSCALE, points[i].y*DRAWSCALE);
  ctx.stroke();      
}

function drawSVG() {  
  var textarea = document.getElementById("result");
  textarea.value = "change layer bNames; change width 5mil; change rank 3; ch pour solid; SET WIRE_BEND 2;\n";
  var size = container.viewBox.baseVal;
  var exportHeight = size.height*SCALE;
  canvas.width = size.width*DRAWSIZE;
  canvas.height = size.height*DRAWSIZE;
  
  
  
  ctx.beginPath();
  ctx.lineWidth = 1;
  var scale = 1/96;
  var col = 0;
  var paths = container.getElementsByTagName("path");
  for (var i=0;i<paths.length;i++) {    
    var path = paths[i]; // SVGPathElement
    var filled = (path.style.fill!==undefined && path.style.fill!="none");
    var transform = path.ownerSVGElement.getScreenCTM().inverse().multiply(path.getScreenCTM())
    var l = path.getTotalLength();
    var divs = Math.round(l*SUBSAMPLING);
    if (divs<3) divs = 3;
    var maxLen = l * 1.5 * SCALE / (divs);
    var p = path.getPointAtLength(0).matrixTransform(transform);
    p = {x:p.x*SCALE, y:p.y*SCALE};
    var last = p;
    var polys = [];
    var points = [];   
    for (var s=0;s<=divs;s++) {
      p = path.getPointAtLength(s*l/divs).matrixTransform(transform);
      p = {x:p.x*SCALE, y:p.y*SCALE};
      if (dist(p,last)>maxLen) {
        points = simplify(points, SIMPLIFY, SIMPLIFYHQ);
        polys.push(points);
        //ctx.strokeStyle = `hsl(${col+=20},100%,50%)`;
        //plotPoly(points);
        points = [p];
      } else {
        points.push(p);
      }
      last = p;
    }
    points = simplify(points, SIMPLIFY, SIMPLIFYHQ);
    polys.push(points);
    ctx.strokeStyle = `hsl(${col+=20},100%,50%)`;
    //plotPoly(points);
    points = unpackPoly(polys);
    
    plotPoly(points);
    
    // 
    points.push(points[0]);    
    var scriptLine;
    if (filled) {
      scriptLine = "polygon "+TRACEWIDTH+" "      
    } else {
      scriptLine = "wire "+TRACEWIDTH+" "      
    }
    points.forEach(function(p) { scriptLine += ` (${p.x.toFixed(6)} ${(exportHeight-p.y).toFixed(6)})`});
    scriptLine += ";"
    textarea.value += scriptLine+"\n";
  }
  container.style.display="none";
}

window.addEventListener("load", function(event) {
  container = document.getElementById("container");
  canvas = document.getElementById("can");  
  ctx = canvas.getContext('2d');
  loadSVG("patreon_path.svg");
});
</script>
</body>
</html>
